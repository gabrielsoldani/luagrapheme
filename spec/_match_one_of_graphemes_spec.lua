local _match_one_of_graphemes = require("luagrapheme")._match_one_of_graphemes

describe("luagrapheme._match_one_of_graphemes", function()
   it("exists", function()
      assert.is_not_nil(_match_one_of_graphemes)
   end)

   it("errors when there are no arguments", function()
      assert.has_error(function()
         _match_one_of_graphemes()
      end, "expected at least 1 string argument")
   end)

   it("errors when an argument is not a string", function()
      assert.has_error(function()
         _match_one_of_graphemes("h", nil)
      end, "bad argument #2 to '_match_one_of_graphemes' (string expected, got nil)")
   end)

   it("errors when an argument is not 1 grapheme", function()
      assert.has_error(function()
         _match_one_of_graphemes("hello")
      end, "bad argument #1 to '_match_one_of_graphemes' (expected 1 grapheme, got many)")
      assert.has_error(function()
         _match_one_of_graphemes("")
      end, "bad argument #1 to '_match_one_of_graphemes' (expected 1 grapheme, got 0)")
      assert.has_no_error(function()
         _match_one_of_graphemes("👩‍🚀")
      end)
   end)

   describe("its closure", function()
      it("errors when argument #1 is not a string", function()
         assert.has_error(function()
            _match_one_of_graphemes("👩‍🚀")(nil)
         end, "bad argument #1 to '?' (string expected, got nil)")
      end)

      it("errors when argument #2 is not an integer", function()
         assert.has_error(function()
            _match_one_of_graphemes("👩‍🚀")("hello", nil)
         end, "bad argument #2 to '?' (number expected, got nil)")
         assert.has_no_error(function()
            _match_one_of_graphemes("👩‍🚀")("hello", "2")
         end)
      end)

      it("errors when argument #2 is out of bounds", function()
         assert.has_error(function()
            _match_one_of_graphemes("👩‍🚀")("hello", -1)
         end, "bad argument #2 to '?' (index out of range)")
         assert.has_error(function()
            _match_one_of_graphemes("👩‍🚀")("hello", 0)
         end, "bad argument #2 to '?' (index out of range)")
         assert.has_error(function()
            _match_one_of_graphemes("👩‍🚀")("hello", 7)
         end, "bad argument #2 to '?' (index out of range)")
      end)

      it("does not error when argument #2 is 1 past the end of the string", function()
         assert.has_no_error(function()
            _match_one_of_graphemes("👩‍🚀")("hello", 6)
         end)
      end)

      it("works with an empty string", function()
         assert.is.falsy(_match_one_of_graphemes("h", "i")("", 1))
      end)

      it("works with ASCII text", function()
         local closure = _match_one_of_graphemes("h", "i")
         assert.are_equal(2, closure("hi", 1))
         assert.are_equal(3, closure("hi", 2))
         assert.is.falsy(closure("hi", 3))
      end)

      it("works with multi-codepoint grapheme clusters", function()
         local closure = _match_one_of_graphemes("👩‍🚀", "🌒", "o")
         assert.is_falsy(closure("he👩‍🚀llo", 1))
         assert.is_falsy(closure("he👩‍🚀llo", 2))
         assert.are_equal(14, closure("he👩‍🚀llo", 3))
         assert.is_falsy(closure("he👩‍🚀llo", 14))
         assert.is_falsy(closure("he👩‍🚀llo", 15))
         assert.are_equal(17, closure("he👩‍🚀llo", 16))
      end)

      it("should not do partial matches", function()
         -- 👩‍🚀 starts with 👩
         local woman = _match_one_of_graphemes("👩")
         assert.is_falsy(woman("👩‍🚀", 1))
      end)
   end)
end)
